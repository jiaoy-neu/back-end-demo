name: Manual Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0)'
        required: true
      release_type:
        description: 'å‘å¸ƒç±»å‹'
        required: true
        default: 'stable'
        type: choice
        options:
          - stable
          - prerelease
          - draft
      changelog:
        description: 'å‘å¸ƒè¯´æ˜'
        required: false
        default: ''
      debug:
        description: 'æ˜¯å¦å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼ˆæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  build-frontend:
    runs-on: ubuntu-latest
    env:
      IS_DEBUG: ${{ github.event.inputs.debug }}
    
    steps:
    - name: æ£€å‡ºå‰ç«¯ä»£ç 
      uses: actions/checkout@v4
      with:
        repository: jiaoy-neu/front-end-demo
        ref: master
        path: frontend
    
    - name: è®¾ç½® Node.js 16.13.2
      uses: actions/setup-node@v4
      with:
        node-version: '16.13.2'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: å®‰è£…ä¾èµ–
      working-directory: ./frontend
      run: npm ci
    
    - name: æ„å»ºå‰ç«¯
      working-directory: ./frontend
      run: npm run build
      env:
        NODE_ENV: production
    
    - name: éªŒè¯æ„å»ºç»“æœ
      if: env.IS_DEBUG == 'true'
      working-directory: ./frontend
      run: |
        echo "ğŸ” è°ƒè¯•æ¨¡å¼ï¼šå‰ç«¯æ„å»ºç»“æœ:"
        ls -la dist/
        echo "index.htmlå­˜åœ¨: $(ls dist/index.html 2>/dev/null && echo 'æ˜¯' || echo 'å¦')"
    
    - name: ä¸Šä¼ å‰ç«¯æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: frontend-dist
        path: frontend/dist/
        retention-days: 1
        if-no-files-found: error

  release:
    runs-on: ubuntu-latest
    needs: build-frontend
    permissions:
      contents: write
    env:
      IS_DEBUG: ${{ github.event.inputs.debug }}
    
    steps:
    - name: æ£€å‡ºåç«¯ä»£ç 
      uses: actions/checkout@v4
    
    - name: ä¸‹è½½å‰ç«¯æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: frontend-dist
        path: frontend-dist
    
    - name: æ£€æŸ¥ç›®å½•ç»“æ„
      if: env.IS_DEBUG == 'true'
      run: |
        echo "ğŸ” è°ƒè¯•æ¨¡å¼ï¼šå½“å‰å·¥ä½œç›®å½•: $(pwd)"
        echo "ğŸ” è°ƒè¯•æ¨¡å¼ï¼šç›®å½•ç»“æ„:"
        ls -la
        echo "ğŸ” è°ƒè¯•æ¨¡å¼ï¼šåç«¯é¡¹ç›®ç»“æ„:"
        find . -type d -name "src" | head -10
        echo "ğŸ” è°ƒè¯•æ¨¡å¼ï¼šå‰ç«¯æ„å»ºäº§ç‰©:"
        ls -la frontend-dist/
    
    - name: å¤åˆ¶å‰ç«¯æ–‡ä»¶åˆ°åç«¯ç›®å½•
      run: |
        # ç¡®å®šç›®æ ‡ç›®å½•
        if [ -d "src/main/webapp" ]; then
          TARGET_DIR="src/main/webapp/public"
        elif [ -d "back/src/main/webapp" ]; then
          TARGET_DIR="back/src/main/webapp/public"
        else
          if [ "${{ github.event.inputs.debug }}" == "true" ]; then
            echo "ğŸ” è°ƒè¯•æ¨¡å¼ï¼šæœªæ‰¾åˆ°webappç›®å½•ï¼Œå°è¯•åˆ›å»º..."
          fi
          mkdir -p src/main/webapp
          TARGET_DIR="src/main/webapp/public"
        fi
        
        if [ "${{ github.event.inputs.debug }}" == "true" ]; then
          echo "ğŸ” è°ƒè¯•æ¨¡å¼ï¼šç›®æ ‡ç›®å½•: $TARGET_DIR"
        fi
        
        mkdir -p "$TARGET_DIR"
        cp -rf frontend-dist/* "$TARGET_DIR/"
        
        # éªŒè¯å¤åˆ¶ç»“æœ
        if [ -f "$TARGET_DIR/index.html" ]; then
          echo "âœ… æˆåŠŸå¤åˆ¶å‰ç«¯æ–‡ä»¶"
          if [ "${{ github.event.inputs.debug }}" == "true" ]; then
            echo "ğŸ” è°ƒè¯•æ¨¡å¼ï¼šæ–‡ä»¶æ•°é‡: $(find "$TARGET_DIR" -type f | wc -l)"
          fi
        else
          echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°index.html"
          if [ "${{ github.event.inputs.debug }}" == "true" ]; then
            echo "ğŸ” è°ƒè¯•æ¨¡å¼ï¼šå°è¯•åˆ—å‡ºæ‰€æœ‰å¯èƒ½çš„ä½ç½®:"
            find . -name "index.html" -type f 2>/dev/null || true
          fi
          exit 1
        fi
    
    - name: è®¾ç½® Java
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
    
    - name: ç”Ÿæˆæ„å»ºæ—¶é—´
      id: timestamp
      run: echo "build_time=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
        
    - name: åˆ›å»º Git æ ‡ç­¾
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"
        git tag -a v${{ github.event.inputs.version }} -m "Release v${{ github.event.inputs.version }}"
        git push origin v${{ github.event.inputs.version }}
    
    - name: æ„å»º WAR
      run: |
        if [ "${{ github.event.inputs.debug }}" == "true" ]; then
          echo "ğŸ” è°ƒè¯•æ¨¡å¼ï¼šå¼€å§‹æ„å»ºWARåŒ…..."
        fi
        
        mvn clean install -DskipTests
        
        if [ "${{ github.event.inputs.debug }}" == "true" ]; then
          echo "ğŸ” è°ƒè¯•æ¨¡å¼ï¼šæŸ¥æ‰¾WARæ–‡ä»¶..."
          find . -name "*.war" -type f 2>/dev/null || echo "æœªæ‰¾åˆ°WARæ–‡ä»¶"
        fi
        
        # å¤åˆ¶å¹¶é‡å‘½åWARæ–‡ä»¶
        for war in target/*.war; do
          if [ -f "$war" ]; then
            cp "$war" "app-${{ github.event.inputs.version }}.war"
            if [ "${{ github.event.inputs.debug }}" == "true" ]; then
              echo "âœ… å·²å¤åˆ¶: $war -> app-${{ github.event.inputs.version }}.war"
            fi
            break
          fi
        done
        
        if [ ! -f "app-${{ github.event.inputs.version }}.war" ]; then
          echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°æˆ–å¤åˆ¶WARæ–‡ä»¶"
          if [ "${{ github.event.inputs.debug }}" == "true" ]; then
            echo "ğŸ” è°ƒè¯•æ¨¡å¼ï¼šå°è¯•æ‰‹åŠ¨æŸ¥æ‰¾:"
            find . -name "*.war" -type f
          fi
          exit 1
        fi
        
        echo "âœ… WARæ„å»ºå®Œæˆ: app-${{ github.event.inputs.version }}.war"
    
    - name: åˆ›å»º Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.event.inputs.version }}
        name: Release v${{ github.event.inputs.version }}
        body: |
          ${{ github.event.inputs.changelog }}
          
          ## ğŸ”§ ä½¿ç”¨è¯´æ˜
          è¿è¡Œåº”ç”¨:
          ```bash
          éœ€è¦å°†WARæ”¾åˆ°Tomcatä¸­è¿è¡Œ
          ```
          
          ## ğŸ“Š æ„å»ºä¿¡æ¯
          - æ„å»ºæ—¶é—´: UTC ${{ steps.timestamp.outputs.build_time }}
          - å‰ç«¯: Vue.js (Node.js 16.13.2)
          - åç«¯: Java 21 (Temurin)
          - æäº¤: ${{ github.sha }}
          - æ„å»ºå·: ${{ github.run_number }}
          - è°ƒè¯•æ¨¡å¼: ${{ github.event.inputs.debug }}
          
          ## ğŸ“¦ æ–‡ä»¶è¯´æ˜
          - `app-${{ github.event.inputs.version }}.war`: å®Œæ•´åº”ç”¨åŒ…ï¼ŒåŒ…å«å‰åç«¯
        draft: ${{ github.event.inputs.release_type == 'draft' }}
        prerelease: ${{ github.event.inputs.release_type == 'prerelease' }}
        files: |
          app-${{ github.event.inputs.version }}.war
        token: ${{ secrets.GITHUB_TOKEN }}
